<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Recommendation System</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Onboarding Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-bottom: 10px;
            color: #f5c518;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: #ccc;
        }

        .rating-progress {
            font-weight: bold;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        /* Star Rating Widget */
        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse;
            justify-content: center;
            margin-top: 10px;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 24px;
            color: #444;
            cursor: pointer;
            transition: color 0.2s;
            margin: 0 2px;
        }

        .star-rating label:hover,
        .star-rating label:hover~label,
        .star-rating input:checked~label {
            color: #f5c518;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Onboarding Modal -->
        <div id="onboarding-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h2>Welcome to Your New Account! üçø</h2>
                <p>To give you the best recommendations, please rate at least 5 movies below or search for your
                    favorites.</p>
                <div class="search-container" style="margin-bottom: 20px;">
                    <input type="text" id="onboarding-search" placeholder="Search for your favorite movies..."
                        autocomplete="off">
                </div>
                <div class="rating-progress" id="rating-progress">Ratings Needed: 5</div>
                <div id="onboarding-movies" class="movie-row" style="justify-content: center; flex-wrap: wrap;"></div>
            </div>
        </div>

        <!-- Auth Section -->
        <div id="auth-container" style="text-align: right; margin-bottom: 20px;">
            <div id="logged-out-view">
                <a href="/login"
                    style="padding: 8px 16px; background-color: #f5c518; color: black; text-decoration: none; border-radius: 4px; font-weight: bold;">Login
                    / Sign Up</a>
            </div>
            <div id="logged-in-view" style="display: none;">
                <span id="user-email" style="margin-right: 15px; font-weight: bold;"></span>
                <button onclick="loadPersonalRecommendations()"
                    style="padding: 8px 16px; background-color: #f5c518; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px;">My
                    Recommendations</button>
                <button onclick="handleLogout()"
                    style="padding: 8px 16px; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <h1>üé¨ Movie Recommendation System</h1>

        <div class="search-container">
            <input type="text" id="movie-search" placeholder="Search for a movie..." autocomplete="off">
            <div id="suggestions" class="suggestions-box"></div>
        </div>

        <div id="personal-recommendations-section" style="display: none;">
            <h2>Your Personal Recommendations</h2>
            <div id="personal-recommendations" class="movie-row"></div>
        </div>

        <div id="recommendations-section" style="display: none;">
            <h2>Recommended Movies</h2>
            <div id="recommendations" class="movie-row"></div>
        </div>

        <h2>Top Rated Movies</h2>
        <div id="top-rated" class="movie-row"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase (Values injected from backend via Jinja2)
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";

        // Debug Logger
        function logDebug(message, data = null) {
            console.log(message, data);
        }

        // Fix: Use 'supabaseClient' instead of 'supabase' to avoid shadowing the global 'supabase' variable from CDN
        let supabaseClient = null;
        try {
            if (!supabaseUrl || !supabaseKey || supabaseUrl.includes("None") || supabaseKey.includes("None")) {
                throw new Error("Missing Supabase Configuration. Check .env file.");
            }

            // Check if global supabase object exists
            if (typeof supabase === 'undefined') {
                throw new Error("Supabase JS Library not loaded. Check internet connection or CDN.");
            }

            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            logDebug("Supabase Initialized", { url: supabaseUrl });
        } catch (err) {
            logDebug("CRITICAL ERROR: Supabase Init Failed", err.message);
            alert("Critical Error: " + err.message);
        }

        const searchInput = document.getElementById("movie-search");
        const suggestionsBox = document.getElementById("suggestions");
        const recommendationsSection = document.getElementById("recommendations-section");
        const recommendationsBox = document.getElementById("recommendations");
        const topRatedBox = document.getElementById("top-rated");

        const authContainer = document.getElementById("auth-container");
        const loggedOutView = document.getElementById("logged-out-view");
        const loggedInView = document.getElementById("logged-in-view");
        const userEmailSpan = document.getElementById("user-email");
        const authMessage = document.getElementById("auth-message");
        const personalRecSection = document.getElementById("personal-recommendations-section");
        const personalRecBox = document.getElementById("personal-recommendations");

        let currentUser = null;

        // Load Top Rated Movies on Startup
        window.onload = async () => {
            logDebug("Application Loaded");
            if (supabaseClient) {
                await checkUser();
            } else {
                logDebug("Skipping User Check - Supabase not ready");
            }

            try {
                const response = await fetch("/recommend/cold-start?top_k=5");
                const data = await response.json();
                const movies = data.recommendations;

                topRatedBox.innerHTML = "";
                movies.forEach(movie => {
                    topRatedBox.appendChild(createMovieCard(movie));
                });
                logDebug("Top Rated Movies Loaded");
            } catch (err) {
                logDebug("Error loading top rated movies", err.message);
            }
        };

        // Auth Functions
        async function checkUser() {
            logDebug("Checking User Session...");
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error) {
                    logDebug("Session Check Error", error);
                    return;
                }

                if (session) {
                    currentUser = session.user;
                    logDebug("User found in session", currentUser.email);
                    updateAuthUI(true);
                    await checkOnboardingRequired(session.access_token);
                } else {
                    currentUser = null;
                    logDebug("No active session");
                    updateAuthUI(false);
                }

                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    logDebug("Auth State Changed", event);
                    if (event === 'SIGNED_IN') {
                        currentUser = session.user;
                        updateAuthUI(true);
                        await checkOnboardingRequired(session.access_token);
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        updateAuthUI(false);
                        document.getElementById("onboarding-modal").style.display = "none";
                    }
                });
            } catch (err) {
                logDebug("Unlockable error in checkUser", err.message);
            }
        }

        // --- Onboarding Logic ---
        let userRatingCount = 0;

        async function checkOnboardingRequired(token) {
            try {
                // Fetch user's rating count from Supabase
                const { count, error } = await supabaseClient
                    .from('ratings')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                if (count < 5) {
                    userRatingCount = count;
                    showOnboardingModal();
                } else {
                    document.getElementById("onboarding-modal").style.display = "none";
                }
            } catch (err) {
                logDebug("Error checking onboarding status", err.message);
            }
        }

        async function showOnboardingModal() {
            const modal = document.getElementById("onboarding-modal");
            const moviesContainer = document.getElementById("onboarding-movies");
            const progress = document.getElementById("rating-progress");

            progress.innerText = `Ratings Needed: ${5 - userRatingCount}`;
            modal.style.display = "flex";

            if (moviesContainer.children.length === 0) {
                try {
                    // Fetch popular movies for new users to rate
                    const response = await fetch("/recommend/cold-start?top_k=20");
                    const data = await response.json();

                    data.recommendations.forEach(movie => {
                        moviesContainer.appendChild(createMovieCard(movie));
                    });
                } catch (err) {
                    logDebug("Error loading onboarding movies", err.message);
                }
            }
        }

        // --- Onboarding Search Handler ---
        const onboardingSearchInput = document.getElementById("onboarding-search");
        let onboardingSearchTimeout = null;

        onboardingSearchInput.addEventListener("input", () => {
            clearTimeout(onboardingSearchTimeout);
            const query = onboardingSearchInput.value;

            if (query.length < 2) {
                // If they clear the search, maybe re-trigger the default popular movies
                if (query.length === 0) {
                    document.getElementById("onboarding-movies").innerHTML = "";
                    showOnboardingModal();
                }
                return;
            }

            // Debounce the fetch to avoid spamming the backend
            onboardingSearchTimeout = setTimeout(async () => {
                const response = await fetch(`/search?query=${query}`);
                const movies = await response.json();

                const moviesContainer = document.getElementById("onboarding-movies");
                moviesContainer.innerHTML = ""; // clear popular movies

                if (movies.length === 0) {
                    moviesContainer.innerHTML = "<p style='color: white;'>No movies found. Try another search!</p>";
                    return;
                }

                movies.forEach(movie => {
                    moviesContainer.appendChild(createMovieCard(movie));
                });
            }, 300); // 300ms delay
        });

        function updateAuthUI(isLoggedIn) {
            const loggedInView = document.getElementById("logged-in-view");
            if (isLoggedIn) {
                loggedOutView.style.display = "none";
                loggedInView.style.display = "block";
                const userName = currentUser.user_metadata?.full_name;
                const displayIdentifier = userName ? userName : currentUser.email;
                userEmailSpan.innerText = "Welcome, " + displayIdentifier;
            } else {
                loggedOutView.style.display = "block";
                loggedInView.style.display = "none";
                personalRecSection.style.display = "none";
            }
        }



        async function handleLogout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) logDebug('Error logging out:', error);
            else logDebug("Logged out successfully");
        }

        async function loadPersonalRecommendations() {
            if (!currentUser) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            const token = session.access_token;

            try {
                const response = await fetch("/recommend/user/personal", {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch recommendations');

                const data = await response.json();
                const movies = data.recommendations;

                personalRecSection.style.display = "block";
                personalRecBox.innerHTML = "";
                movies.forEach(movie => {
                    personalRecBox.appendChild(createMovieCard(movie));
                });
            } catch (error) {
                console.error(error);
                alert("Error fetching personal recommendations.");
            }
        }


        searchInput.addEventListener("input", async () => {
            if (!currentUser) {
                // Clear input if user tries to type without login
                if (searchInput.value.length > 0) {
                    alert("Please login to search for movies!");
                    searchInput.value = "";
                }
                return;
            }

            const query = searchInput.value;

            if (query.length < 2) {
                suggestionsBox.innerHTML = "";
                return;
            }

            const response = await fetch(`/search?query=${query}`);
            const movies = await response.json();

            suggestionsBox.innerHTML = "";

            movies.forEach(movie => {
                const div = document.createElement("div");
                div.classList.add("suggestion-item");
                div.innerText = movie.title;

                div.onclick = () => {
                    searchInput.value = movie.title;
                    suggestionsBox.innerHTML = "";
                    loadRecommendations(movie.movieId);
                };

                suggestionsBox.appendChild(div);
            });
        });

        async function loadRecommendations(movieId) {
            const response = await fetch(`/recommend/similar/${movieId}`);
            const data = await response.json();
            const movies = data.recommendations;

            recommendationsSection.style.display = "block";
            recommendationsBox.innerHTML = "";

            movies.forEach(movie => {
                recommendationsBox.appendChild(createMovieCard(movie));
            });
        }

        function createMovieCard(movie) {
            const card = document.createElement("div");
            card.classList.add("movie-card");

            // Clean up genres for display (take first 2)
            const genres = movie.genres ? movie.genres.replace(/\|/g, ', ') : 'Unknown';
            const poster = movie.poster ? movie.poster : "https://via.placeholder.com/200x300?text=No+Poster";

            const imdbLinkHtml = movie.imdb_link
                ? `<a href="${movie.imdb_link}" target="_blank" class="imdb-link" style="display: block; margin-top: 5px; color: #f5c518; text-decoration: none; font-weight: bold;">Watch ‚Üó</a>`
                : '';

            const uniqueId = Math.random().toString(36).substring(7);

            card.innerHTML = `
                <img src="${poster}" alt="${movie.title}" loading="lazy">
                <div class="movie-info">
                    <h3>${movie.title}</h3>
                    <p>üé≠ ${genres}</p>
                    ${imdbLinkHtml}
                    ${currentUser ? `
                    <div class="star-rating" id="rating-${uniqueId}">
                        <input type="radio" id="star5-${uniqueId}" name="rating-${uniqueId}" value="5" onclick="rateMovie(${movie.movieId}, 5, '${uniqueId}')" />
                        <label for="star5-${uniqueId}">‚òÖ</label>
                        <input type="radio" id="star4-${uniqueId}" name="rating-${uniqueId}" value="4" onclick="rateMovie(${movie.movieId}, 4, '${uniqueId}')" />
                        <label for="star4-${uniqueId}">‚òÖ</label>
                        <input type="radio" id="star3-${uniqueId}" name="rating-${uniqueId}" value="3" onclick="rateMovie(${movie.movieId}, 3, '${uniqueId}')" />
                        <label for="star3-${uniqueId}">‚òÖ</label>
                        <input type="radio" id="star2-${uniqueId}" name="rating-${uniqueId}" value="2" onclick="rateMovie(${movie.movieId}, 2, '${uniqueId}')" />
                        <label for="star2-${uniqueId}">‚òÖ</label>
                        <input type="radio" id="star1-${uniqueId}" name="rating-${uniqueId}" value="1" onclick="rateMovie(${movie.movieId}, 1, '${uniqueId}')" />
                        <label for="star1-${uniqueId}">‚òÖ</label>
                    </div>` : ''}
                </div>
            `;
            return card;
        }

        async function rateMovie(movieId, rating, widgetId) {
            if (!currentUser) {
                alert("Please login to rate movies!");
                return;
            }

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();

                const response = await fetch(`/feedback/rate?movie_id=${movieId}&rating=${rating}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                });

                if (response.ok) {
                    // Visually disable widget after successful rating
                    const widget = document.getElementById(`rating-${widgetId}`);
                    widget.style.pointerEvents = 'none';
                    widget.style.opacity = '0.5';

                    // Update onboarding if visible
                    const modal = document.getElementById("onboarding-modal");
                    if (modal.style.display !== "none") {
                        userRatingCount++;
                        const needed = 5 - userRatingCount;
                        if (needed <= 0) {
                            modal.style.display = "none";
                            alert("Thank you! Your account is fully set up.");
                            // Reload recommendations since they have ratings now
                            loadPersonalRecommendations();
                        } else {
                            document.getElementById("rating-progress").innerText = `Ratings Needed: ${needed}`;
                        }
                    }
                } else {
                    const errorData = await response.json();
                    alert("Error saving rating: " + (errorData.detail || 'Unknown error'));
                }
            } catch (err) {
                console.error("Failed to submit rating", err);
            }
        }
    </script>

</body>

</html>